var e=require("path"),i=require("pixelmatch"),t=require("fs"),a=require("pngjs"),n=require("move-file");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var f,s=/*#__PURE__*/r(e),u=/*#__PURE__*/r(i),l=/*#__PURE__*/r(t),d=/*#__PURE__*/r(n),h="__cp-visual-regression-diff_snapshots__";!function(e){e.diff=".diff",e.actual=".actual"}(f||(f={}));var o=function(e,i){return function(t){for(var a=function(t,a){return a>i||t>e},n=0;n<t.height;n++)for(var r=0;r<t.width;r++)if(a(r,n)){var f=t.width*n+r<<2;t.data[f]=0,t.data[f+1]=0,t.data[f+2]=0,t.data[f+3]=64}return t}};exports.initPlugin=function(e,i){var t;e("task",((t={})["cp-visual-regression-diff-getScreenshotPath"]=function(e){var i=e.title,t=e.imagesDir;return s.default.join.apply(s.default,[h,s.default.dirname(e.specPath)].concat(t.split("/"),[""+i+f.actual+".png"]))},t["cp-visual-regression-diff-doesFileExist"]=function(e){return l.default.existsSync(e.path)},t["cp-visual-regression-diff-approveImage"]=function(e){var i=e.img,t=i.replace(f.actual,"");l.default.existsSync(t)&&l.default.unlinkSync(t);var a=i.replace(f.actual,f.diff);return l.default.existsSync(a)&&l.default.unlinkSync(a),l.default.existsSync(i)&&d.default.sync(i,t),null},t["cp-visual-regression-diff-compareImages"]=function(e){var i,t;if(l.default.existsSync(e.imgOld)&&!e.updateImages){var n=a.PNG.sync.read(l.default.readFileSync(e.imgNew)),r=a.PNG.sync.read(l.default.readFileSync(e.imgOld)),s=n.height!==r.height||n.width!==r.width,h=s?function(e,i){var t,n,r=e.width,f=e.height,s=i.width,u=i.height,l=(t=Math.max(r,s),n=Math.max(f,u),function(e){var i=new a.PNG({width:t,height:n,fill:!0});return a.PNG.bitblt(e,i,0,0,e.width,e.height,0,0),i}),d=l(e),h=l(i);return[o(r,f)(d),o(s,u)(h)]}(n,r):[n,r],c=h[0],g=h[1],m=c.width,p=c.height,v=new a.PNG({width:m,height:p}),w=Object.assign({includeAA:!0},e.diffConfig);if(i=u.default(c.data,g.data,v.data,m,p,w)/m*p,s?t="Images size mismatch - new screenshot is "+n.width+"px by "+n.height+"px while old one is "+r.width+"px by "+r.height+" (width x height).":i>e.maxDiffThreshold&&(t="Image diff factor ("+Math.ceil(1e3*i)/1e3+") is bigger than maximum threshold option "+e.maxDiffThreshold),t)return l.default.writeFileSync(e.imgNew.replace(f.actual,f.diff),a.PNG.sync.write(v)),{error:!0,message:t,imgDiff:i,maxDiffThreshold:e.maxDiffThreshold};l.default.unlinkSync(e.imgOld)}else i=0;return d.default.sync(e.imgNew,e.imgOld),void 0!==i?{message:"Image diff ("+Math.ceil(1e3*i)/1e3+"%) is within boundaries of maximum threshold option "+e.maxDiffThreshold,imgDiff:i,maxDiffThreshold:e.maxDiffThreshold}:null},t)),e("after:screenshot",function(e){var t;if(0===(null==(t=e.name)?void 0:t.indexOf(h)))return new Promise(function(t,a){var n=function(e,i){if(e[i])return e[i];throw"[Image snapshot] CypressConfig."+i+" cannot be missing or `false`!"}(i,"screenshotsFolder"),r=e.name.substring(h.length+s.default.sep.length),f=s.default.normalize(s.default.join(i.projectRoot,r));d.default(e.path,f).then(function(){l.default.rm(s.default.join(n,h),{recursive:!0,force:!0},function(e){if(e)return a(e);t({path:f})})}).catch(a)})})};
//# sourceMappingURL=plugins.js.map

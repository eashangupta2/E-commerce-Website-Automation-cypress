function e(){return e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},e.apply(this,arguments)}var t,n="cp-visual-regression-diff",r="#"+n+"-",s=n+"-overlay";!function(e){e.diff=".diff",e.actual=".actual"}(t||(t={}));var o={getScreenshotPath:n+"-getScreenshotPath",compareImages:n+"-compareImages",approveImage:n+"-approveImage",doesFileExist:n+"-doesFileExist"},i={};function a(){cy.queue.clear(),cy.state("index",0)}function c(){cy.queue.run()}function u(e,t,n){return e[t]?Cypress.Promise.resolve(e[t]):cy.readFile(t,n,{log:!1}).then(function(n){return e[t]=n})}Cypress.Commands.add("matchImage",{prevSubject:"optional"},function(n,s){void 0===s&&(s={});var a=Cypress.currentTest.titlePath.join(" ");void 0===i[a]&&(i[a]=-1),a+=" #"+ ++i[a];var c=s.updateImages||Cypress.env("pluginVisualRegressionUpdateImages")||!1,u=s.imagesDir||Cypress.env("pluginVisualRegressionImagesDir")||"__image_snapshots__",f=s.maxDiffThreshold||Cypress.env("pluginVisualRegressionMaxDiffThreshold")||.01,l=s.diffConfig||Cypress.env("pluginVisualRegressionDiffConfig")||{},p=s.screenshotConfig||Cypress.env("pluginVisualRegressionScreenshotConfig")||{};return cy.then(function(){return cy.task(o.getScreenshotPath,{title:a,imagesDir:u,specPath:Cypress.spec.relative},{log:!1})}).then(function(t){var r;return(n?cy.wrap(n):cy).screenshot(t,e({},p,{onAfterScreenshot:function(e,t){r=t.path,null==p.onAfterScreenshot||p.onAfterScreenshot(e,t)},log:!1})).then(function(){return r})}).then(function(e){return cy.task(o.compareImages,{imgNew:e,imgOld:e.replace(t.actual,""),updateImages:c,maxDiffThreshold:f,diffConfig:l},{log:!1}).then(function(t){return{res:t,imgPath:e}})}).then(function(e){var t=e.res,s=e.imgPath,o=Cypress.log({name:"log",displayName:"Match image",$el:n});if(!t){o.set("message","Unexpected error!");var i=new Error("Unexpected error!");throw i.onFail=function(e){return o.error(e)},i}if(t.error){o.set("message",t.message+"\n[See comparison]("+r+btoa(JSON.stringify({title:a,imgPath:s}))+")"),o.set("consoleProps",function(){return t});var c=new Error(t.message);throw c.onFail=function(e){return o.error(e)},c}o.set("message",t.message)})}),before(function(){if(!top)return null;Cypress.$("."+s,top.document.body).remove()}),after(function(){var e={};if(!top)return null;Cypress.$(top.document.body).on("click",'a[href^="'+r+'"]',function(n){if(n.preventDefault(),!top)return!1;var i=JSON.parse(atob(n.currentTarget.getAttribute("href").substring(r.length))),f=i.title,l=i.imgPath;return a(),u(e,l,"base64").then(function(n){return u(e,l.replace(t.actual,""),"base64").then(function(r){return u(e,l.replace(t.actual,t.diff),"base64").then(function(e){return cy.task(o.doesFileExist,{path:l},{log:!1}).then(function(t){return[n,r,e,t]})})})}).then(function(e){var t=e[0],n=e[1],r=e[2],i=e[3];if(!top)return!1;a(),Cypress.$(function(e,t,n,r,o){return'<div class="'+s+' runner" style="position:fixed;z-index:10;top:0;bottom:0;left:0;right:0">\n  <header style="position:static">\n  <nav style="display:flex;width:100%;align-items:center;justify-content:space-between;padding:10px 15px;">\n    <h2>'+e+" - screenshot diff</h2>\n    <form>\n      "+(o?'<button type="submit"><i class="fa fa-check"></i> Update screenshot</button>':"Image was already updated, rerun test to see new comparison")+'\n      <button type="button" data-type="close"><i class="fa fa-times"></i> Close</button>\n    <form>\n  </nav>\n  </header>\n  <div style="margin:15px;display:flex;justify-content:space-evenly;align-items: flex-end">\n    <div\n      style="position:relative;background:#fff;border:solid 15px #fff"\n      onmouseover="this.querySelector(\'div\').style.opacity=0,this.querySelector(\'img\').style.opacity=1"\n      onmouseleave="this.querySelector(\'div\').style.opacity=1,this.querySelector(\'img\').style.opacity=0"\n    >\n      <h3>New screenshot:</h3>\n      <img style="min-width:300px;width:100%;opacity:0" src="data:image/png;base64,'+t+'" />\n      <div style="position:absolute;top:0;left:0;background:#fff">\n        <h3>Old screenshot (hover over to see the new one):</h3>\n        <img style="min-width:300px;width:100%" src="data:image/png;base64,'+n+'" />\n      </div>\n    </div>\n    <div style="background:#fff;border:solid 15px #fff">\n      <h3>Diff between new and old screenshot</h3>\n      <img style="min-width:300px;width:100%" src="data:image/png;base64,'+r+'" />\n      </div>\n    </div>\n  </div>'}(f,t,n,r,i)).appendTo(top.document.body);var u=Cypress.$("."+s,top.document.body);u.on("click",'button[data-type="close"]',function(){u.remove()}),u.on("submit","form",function(e){e.preventDefault(),cy.task(o.approveImage,{img:l}).then(function(){return u.remove()}),c()})}),c(),!1})});
//# sourceMappingURL=support.js.map
